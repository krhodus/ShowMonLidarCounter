<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ShowMon Config</title>
<style>
body { background:#111; font-family:Arial,sans-serif; color:#eee; margin:25px; }
h1 { text-align:center; margin-bottom:10px; }
.card {
  background:#222; padding:18px; border-radius:10px;
  margin-bottom:20px; box-shadow:0 3px 10px rgba(0,0,0,0.4);
}
label { display:block; margin:6px 0 2px 0; font-size:14px; }
input[type=text], input[type=number], input[type=password] {
  width:100%; max-width:320px;
  padding:6px 8px; border-radius:4px; border:1px solid #555;
  background:#111; color:#eee; box-sizing:border-box;
}
input[type=checkbox] { transform:scale(1.1); margin-right:6px; }
button {
  padding:10px 20px; font-size:15px; margin:5px;
  border:none; border-radius:6px; cursor:pointer;
}
button.blue { background:#007bff; color:#fff; }
button.gray { background:#555; color:#fff; }
.smallNote { font-size:12px; color:#aaa; }
.grid2 {
  display:grid; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
  gap:20px;
}
@media (max-width:900px) {
  .grid2 { grid-template-columns:1fr; }
}
</style>
</head>
<body>

<h1 class="center">
  <img src="{{ url_for('static', filename='images/ShowMon.png') }}" alt="Logo" width:600px height: 120px>
  <br>
  Lidar Car Counter - Configuration </h1>

<div style="text-align:center; margin-bottom:15px;">
  <button class="gray" onclick="location.href='/'">Back to Dashboard</button>
  <button class="gray" onclick="location.href='/schedule'">Schedule Editor</button>
</div>

<form id="cfgForm" onsubmit="saveConfig(event)">

  <div class="grid2">
    <div>
      <div class="card">
        <h2>Core</h2>
        <label>Serial Port</label>
        <input type="text" id="serial_port">

        <label>Baudrate</label>
        <input type="number" id="baudrate">

        <label>Database File</label>
        <input type="text" id="database">
        <div class="smallNote">
          Changing DB name will take effect on next restart.
        </div>
      </div>

      <div class="card">
        <h2>HTTP</h2>
        <label>Port</label>
        <input type="number" id="http_port">
        <div class="smallNote">
          Port changes require a restart.
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <h2>MQTT</h2>
        <label>Broker</label>
        <input type="text" id="mqtt_broker">

        <label>Port</label>
        <input type="number" id="mqtt_port">

        <label>Topic</label>
        <input type="text" id="mqtt_topic">

        <label>Username</label>
        <input type="text" id="mqtt_username">

        <label>Password</label>
        <input type="password" id="mqtt_password">

        <div class="smallNote">
          Changes apply on next restart (existing client is not reconnected live).
        </div>
      </div>

      <div class="card">
        <h2>Detection</h2>
        <label>Debounce (ms)</label>
        <input type="number" id="det_debounce">

        <label>Ignore Zero Distance</label>
        <label>
          <input type="checkbox" id="det_ignore_zero"> Enabled
        </label>

        <label>Minimum Strength</label>
        <input type="number" id="det_min_strength">

        <label>Test Mode (default on boot)</label>
        <label>
          <input type="checkbox" id="det_test_mode"> Start in Test Mode
        </label>
      </div>

      <div class="card">
        <h2>Schedule (Remote)</h2>
        <label>Schedule URL</label>
        <input type="text" id="sch_url">

        <label>Check Interval (sec)</label>
        <input type="number" id="sch_interval">

        <label>GitHub Token</label>
        <input type="password" id="sch_token">

        <div class="smallNote">
          The URL is used by the backend to periodically pull a schedule.
          The local schedule editor (/schedule) reads and writes <code>schedule.json</code> on the Pi.
        </div>
      </div>
    </div>
  </div>

  <div style="text-align:center; margin-bottom:30px;">
    <button class="blue" type="submit">Save Config</button>
    <button class="red" type="button" onclick="saveAndRestart()">
      Save & Restart
    </button>
  </div>
</form>

<script>
async function loadConfig() {
  try {
    const r = await fetch("/api/config");
    const cfg = await r.json();

    document.getElementById("serial_port").value = cfg.serial_port ?? "";
    document.getElementById("baudrate").value = cfg.baudrate ?? 115200;
    document.getElementById("database").value = cfg.database ?? "cars.db";

    const http = cfg.http || {};
    document.getElementById("http_port").value = http.port ?? 80;

    const m = cfg.mqtt || {};
    document.getElementById("mqtt_broker").value = m.broker ?? "";
    document.getElementById("mqtt_port").value = m.port ?? 1883;
    document.getElementById("mqtt_topic").value = m.topic ?? "";
    document.getElementById("mqtt_username").value = m.username ?? "";
    document.getElementById("mqtt_password").value = m.password ?? "";

    const d = cfg.detection || {};
    document.getElementById("det_debounce").value = d.debounce_ms ?? 200;
    document.getElementById("det_ignore_zero").checked = !!d.ignore_zero_distance;
    document.getElementById("det_min_strength").value = d.min_strength ?? 0;
    document.getElementById("det_test_mode").checked = !!d.test_mode;

    const s = cfg.schedule || {};
    document.getElementById("sch_url").value = s.url ?? "";
    document.getElementById("sch_interval").value = s.check_interval_sec ?? 1200;
    document.getElementById("sch_token").value = s.github_token ?? "";

  } catch(e) {
    console.log("loadConfig error", e);
    alert("Failed to load config.");
  }
}

async function saveConfig(ev) {
  ev.preventDefault();

  const payload = {
    serial_port: document.getElementById("serial_port").value,
    baudrate: parseInt(document.getElementById("baudrate").value || "115200", 10),
    database: document.getElementById("database").value,

    http: {
      port: parseInt(document.getElementById("http_port").value || "80", 10)
    },

    mqtt: {
      broker: document.getElementById("mqtt_broker").value,
      port: parseInt(document.getElementById("mqtt_port").value || "1883", 10),
      topic: document.getElementById("mqtt_topic").value,
      username: document.getElementById("mqtt_username").value,
      password: document.getElementById("mqtt_password").value
    },

    detection: {
      debounce_ms: parseInt(document.getElementById("det_debounce").value || "200", 10),
      ignore_zero_distance: document.getElementById("det_ignore_zero").checked,
      min_strength: parseInt(document.getElementById("det_min_strength").value || "0", 10),
      test_mode: document.getElementById("det_test_mode").checked
    },

    schedule: {
      url: document.getElementById("sch_url").value,
      check_interval_sec: parseInt(document.getElementById("sch_interval").value || "1200", 10),
      github_token: document.getElementById("sch_token").value
    }
  };

  try {
    const r = await fetch("/api/config", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    if (!j.ok) {
      alert("Error saving config: " + (j.error || "Unknown error"));
      return;
    }
    alert("Config saved. Some changes apply only after restart.");
  } catch(e) {
    console.log("saveConfig error", e);
    alert("Failed to save config.");
  }
}

async function saveAndRestart() {
  if (!confirm(
    "This will restart the application.\n\n" +
    "The dashboard will disconnect briefly.\n\n" +
    "Continue?"
  )) return;

  // First save config
  const ev = { preventDefault(){} };
  await saveConfig(ev);

  // Restart service
  try {
    await fetch("/api/service/restart", { method: "POST" });
    alert("Service restarting. Please wait 10â€“15 seconds.");
    setTimeout(() => location.href = "/", 12000);
  } catch (e) {
    alert("Failed to restart service.");
  }
}

loadConfig();
</script>

</body>
</html>
